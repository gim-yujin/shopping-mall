# Shopping Mall 부하 테스트 Phase 8 — 종합 분석 보고서

## 1. 캐시 미스 시나리오 비교

### 1.1 전체 성능 비교표

| 지표 | Narrow | Wide | Longtail | Wide/Narrow 비율 |
|------|--------|------|----------|-----------------|
| **p95 응답 시간** | 2,493ms | 2,907ms | 3,030ms | ×1.17 |
| **최대 응답 시간** | 4,844ms | 16,806ms | 7,499ms | ×3.47 |
| **처리량** | 48.3 req/s | 46.8 req/s | 46.2 req/s | ×0.97 |
| **에러율** | 0.00% | 0.09% | 0.00% | — |
| **총 요청 수** | 26,430 | 25,575 | 25,115 | ×0.97 |
| **완료 반복** | 5,286 | 5,115 | 5,023 | ×0.97 |

### 1.2 엔드포인트별 p95 응답 시간

| 엔드포인트 | Narrow | Wide | Longtail | Wide/Narrow 비율 | 판정 |
|-----------|--------|------|----------|-----------------|------|
| **홈페이지** | 59ms | 71ms | 74ms | ×1.20 | ✅ 양호 |
| **상품 목록** | 3,281ms | 5,018ms | 4,101ms | ×1.53 | ⚠️ 병목 |
| **상품 상세** | 62ms | 104ms | 85ms | ×1.68 | ✅ 양호 |
| **검색** | 711ms | 692ms | 853ms | ×0.97 | ✅ 양호 |
| **카테고리** | 61ms | 195ms | 91ms | ×3.20 | ✅ 양호 |

### 1.3 Caffeine 캐시 통계 (최종 스냅샷)

| 캐시 이름 | Narrow 히트율 | Wide 히트율 | Longtail 히트율 | Wide 사이즈 |
|----------|-------------|-----------|--------------|------------|
| **productDetail** | 99.6% | **0.0%** | 78.8% | 100/100 |
| **productReviews** | 99.6% | **0.0%** | 78.8% | 100/100 |
| **categoryBreadcrumb** | 99.7% | **53.6%** | 88.7% | 100/100 |
| **categoryProducts** | 99.8% | 97.7% | 97.5% | 56 |
| **searchResults** | 99.7% | 98.5% | 99.1% | 19 |
| **productList** | 99.7% | 98.9% | 98.8% | 25 |
| subCategories | 99.8% | 97.7% | 97.8% | 56 |
| categoryById | 99.8% | 97.6% | 97.8% | 56 |
| 홈 페이지 캐시 5종 | 99.9% | 99.9% | 99.9% | 1 |
| **TOTAL** | **99.8%** | **82.1%** | **95.5%** | — |

---

## 2. 핵심 발견

### 2.1 인덱스 최적화 양호 — Wide/Narrow p95 비율 ×1.17

전체 p95 기준으로 Wide(2,907ms)가 Narrow(2,493ms) 대비 단 17% 상승에 그쳤다. 판정 기준인 "2배 이내"를 크게 하회하며, 이는 **100만 건 테이블에서 랜덤 PK 조회의 인덱스 성능이 매우 우수**하다는 의미다.

특히 상품 상세(productDetail) 캐시가 0% 히트(Wide)인 상태에서도 p95가 62ms → 104ms로, 매 요청이 100만 건 테이블에서 PK 조회 + JOIN을 수행함에도 100ms 수준을 유지했다.

### 2.2 단일 병목 확인 — 상품 목록(productList) p95 3.3~5.0초

**모든 모드에서 전체 p95를 지배하는 병목은 상품 목록 페이지**다.

- Narrow에서도 이미 p95 = 3,281ms (전체 p95 2,493ms의 원인)
- Wide에서 p95 = 5,018ms로 가장 높은 수치
- 이 엔드포인트를 제외하면 나머지는 전부 p95 < 1초

원인은 `findAllSorted` 쿼리가 100만 행 테이블을 sort별로 정렬 후 페이징하는 구조다. 캐시 히트율이 98.9%(Wide)로 높지만, sort 5종 × page 5종 = 최대 25개 키 조합 중 TTL 만료 시 캐시 미스가 발생하면 full sort가 일어난다. 특히 `price_asc`, `price_desc` 같은 정렬은 해당 컬럼 인덱스가 없으면 filesort가 발생할 수 있다.

### 2.3 캐시 사이즈 제한(maximumSize=100)은 현재 설정에서 적절

Wide 모드에서 productDetail(100/100)과 productReviews(100/100)가 가득 차면서 히트율 0%가 됐지만, 이는 100만 건 균일 분포라는 극단적 시나리오다. **Longtail(80/20 분포)에서는 78.8%를 유지**하며, 이는 실제 운영 환경에서 충분한 수준이다.

searchResults(19/100)와 productList(25/100)는 키 공간이 좁아서 Wide에서도 98%+ 히트율을 보였다. `maximumSize=100`을 늘리는 것보다 상품 목록 쿼리 최적화가 우선이다.

### 2.4 검색은 캐시 미스에 영향받지 않음

검색 p95가 Narrow(711ms) ≈ Wide(692ms)로 거의 동일한 이유는 키워드 19종이 모두 캐시(maximumSize=100) 안에 수용되기 때문이다. 히트 0건 키워드(`없는상품검색어ABC` 등)도 빈 결과가 캐시되므로 두 번째 요청부터는 DB를 건드리지 않는다.

---

## 3. Breakpoint 테스트 분석

### 3.1 Browse 단독 (50 → 700 VU)

| 지표 | 값 |
|------|-----|
| 전체 p95 | 21,065ms |
| 전체 max | 47,030ms |
| 총 처리량 | 37,744 요청 (49.0 req/s) |
| 에러율 | 0.04% |
| browse p95 | 9,939ms |
| 캐시 히트율 | 99.7% (narrow 데이터) |

### 3.2 Mixed: Browse + Shopping (40 → 650 VU)

| 지표 | 값 |
|------|-----|
| 전체 p95 | 13,879ms |
| 전체 max | 40,620ms |
| 총 처리량 | 62,591 요청 (80.0 req/s) |
| 에러율 | 0.30% |
| browse p95 | 7,062ms |
| login p95 | 16,503ms |
| order p95 | 13,517ms |
| 주문 성공/실패 | 2,958 / 297 (성공률 90.9%) |

### 3.3 처리량 포화 분석

두 테스트의 처리량이 **49~80 req/s**로 수렴한 점이 핵심이다.

- **Browse 단독 49 req/s**: VU가 50→700으로 14배 증가해도 처리량은 변하지 않음
- **Mixed 80 req/s**: Shopping의 가벼운 API 요청(장바구니, 주문)이 추가되어 처리량 총합은 높아짐
- 이는 **Tomcat 스레드 + Thymeleaf SSR 렌더링이 병목**임을 확인해 줌
- 캐시 히트율 99.7%에서도 49 req/s가 한계이므로, DB가 아닌 **애플리케이션 레이어(렌더링)**가 제한 요인

### 3.4 시스템 용량 판정

캐시 미스 테스트(100 VU)의 처리량이 46~48 req/s이고, Breakpoint(700 VU)에서도 49 req/s인 점을 종합하면:

- **100 VU 이하**: p95 < 3초 유지 가능 (서비스 품질 양호)
- **200 VU 부근**: p95가 3초를 넘기 시작 (경고선)
- **300+ VU**: p95 10초 이상 (서비스 불가)
- **처리량 천장**: ~49 req/s (Browse), ~80 req/s (Mixed)

---

## 4. 최적화 우선순위 권장

### P0 (즉시) — 상품 목록 쿼리 최적화

현재 모든 시나리오에서 전체 p95를 지배하는 단일 병목이다. 선택지:

1. **sort별 인덱스 추가**: `CREATE INDEX idx_products_price_asc ON products(price ASC) WHERE is_active = true` 등 sort 옵션별 covering index
2. **productList 캐시 TTL 연장**: 5분 → 15분 (상품 목록은 실시간성이 덜 중요)
3. **Materialized View**: 정렬 결과를 주기적으로 갱신하는 별도 테이블

### P1 (차기) — Thymeleaf 렌더링 병목 해소

처리량 천장(49 req/s)이 DB가 아닌 SSR에 의해 결정되므로:

1. **Fragment 캐시**: Thymeleaf의 `th:cache` 또는 Spring Cache로 렌더링된 HTML fragment 캐시
2. **CDN/정적 페이지 생성**: Browse 경로를 SSG(Static Site Generation) 방식으로 전환
3. **비동기 렌더링**: WebFlux 도입으로 Tomcat 스레드 블로킹 해소 (대규모 리팩토링)

### P2 (선택) — 캐시 사이즈 조정

현재 설정은 Longtail 분포에서 충분하지만, 트래픽 패턴이 더 분산될 경우:

- `productDetail`: 100 → 500 (메모리 여유 시)
- `productReviews`: 100 → 500
- `categoryBreadcrumb`: 100 → 300

---

## 5. 보고서용 한 줄 요약

> **단일 인스턴스(8코어, HikariCP pool=17)에서 캐시 적용 후 100 VU까지 p95 < 3초를 유지하며, 처리량 천장은 Browse 49 req/s / Mixed 80 req/s다. 100만 상품 랜덤 조회(캐시 미스율 100%)에서도 p95 상승은 17%에 그쳐 인덱스 효율이 양호하나, 상품 목록 정렬 쿼리(p95 3.3~5.0초)가 전체 성능을 지배하는 단일 병목으로 확인되었다.**
