<!DOCTYPE html>
<!--
    [Step 5] 관리자 반품 관리 페이지.

    문제: 관리자가 반품 대기 건을 확인하고 승인/거절 처리할 수 있는 페이지가 없어
    DB 직접 조회나 주문 상세를 하나씩 확인해야 했다.

    해결: RETURN_REQUESTED 상태의 OrderItem을 테이블로 표시하고,
    각 건에 대해 승인/거절 버튼을 제공한다.
    거절 시 인라인 입력으로 거절 사유를 작성한다.

    데이터 흐름: AdminController.returnList() → OrderService.getReturnRequests()
    → OrderQueryService.getReturnRequests() → OrderItemRepository.findByStatus()
    → AdminReturnResponse DTO 변환 후 Thymeleaf 바인딩
-->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head><title>반품 관리</title></head>
<body>
<div layout:fragment="content">
    <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">반품 관리</h1>
            <a th:href="@{/admin}" class="text-sm text-gray-500 hover:text-gray-700">← 대시보드</a>
        </div>

        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-700" th:text="${successMessage}">성공 메시지</p>
        </div>
        <div th:if="${errorMessage}" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-700" th:text="${errorMessage}">오류 메시지</p>
        </div>

        <!-- Summary Card -->
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
            <div class="flex items-center gap-3">
                <div class="bg-orange-100 rounded-full p-2">
                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-orange-700">처리 대기 중인 반품 신청</p>
                    <p class="text-xl font-bold text-orange-800" th:text="${returns.totalElements}">0</p>
                </div>
            </div>
        </div>

        <!-- Returns Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <!-- 반품 대기 건이 없는 경우 안내 메시지 표시 -->
            <div th:if="${returns.totalElements == 0}" class="p-12 text-center">
                <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="text-gray-500">처리 대기 중인 반품 신청이 없습니다.</p>
            </div>

            <div th:if="${returns.totalElements > 0}" class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                    <tr class="bg-gray-50 border-b text-left text-gray-500">
                        <th class="px-4 py-3">주문번호</th>
                        <th>상품명</th>
                        <th class="text-center">수량</th>
                        <th>반품 사유</th>
                        <th>신청일시</th>
                        <th>신청자</th>
                        <th class="text-center">처리</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="ret : ${returns.content}" class="border-b hover:bg-gray-50">
                        <!-- 주문번호: 클릭 시 주문 상세로 이동할 수 있도록 링크 제공은 하지 않음
                             (관리자 주문 상세 페이지가 별도 존재하지 않으므로 텍스트만 표시) -->
                        <td class="px-4 py-3 font-medium font-mono text-xs" th:text="${ret.orderNumber()}">ORD-001</td>

                        <td class="max-w-[200px] truncate" th:text="${ret.productName()}">상품A</td>

                        <td class="text-center" th:text="${ret.quantity()} + '개'">1개</td>

                        <!-- 반품 사유: AdminReturnResponse.getReturnReasonLabel()로 한글 변환 -->
                        <td>
                            <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-700"
                                  th:text="${ret.returnReasonLabel}">사유</span>
                        </td>

                        <td class="text-gray-500 text-xs"
                            th:text="${ret.returnRequestedAt() != null
                                      ? #temporals.format(ret.returnRequestedAt(), 'MM.dd HH:mm')
                                      : '-'}">03.01 14:00</td>

                        <td class="text-xs">
                            <span th:text="${ret.userName()}" class="font-medium">사용자</span>
                            <span th:if="${ret.userEmail() != null and !ret.userEmail().isEmpty()}"
                                  class="text-gray-400 block" th:text="${ret.userEmail()}">email</span>
                        </td>

                        <td class="text-center">
                            <div class="flex items-center justify-center gap-1">
                                <!-- 승인 버튼 -->
                                <form th:action="@{/admin/returns/{id}/approve(id=${ret.orderItemId()})}" method="post"
                                      onsubmit="return confirm('이 반품을 승인하시겠습니까?\n승인 시 재고 복구 및 환불이 즉시 처리됩니다.')">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="orderId" th:value="${ret.orderId()}"/>
                                    <button type="submit"
                                            class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 transition">
                                        승인
                                    </button>
                                </form>

                                <!-- 거절 버튼: 클릭 시 인라인 거절 사유 입력 영역 토글 -->
                                <button type="button"
                                        th:onclick="'toggleRejectForm(' + ${ret.orderItemId()} + ')'"
                                        class="bg-red-500 text-white px-3 py-1.5 rounded text-xs hover:bg-red-600 transition">
                                    거절
                                </button>
                            </div>

                            <!-- 거절 사유 입력 폼 (기본 숨김, 거절 버튼 클릭 시 표시) -->
                            <div th:id="'reject-form-' + ${ret.orderItemId()}" class="hidden mt-2">
                                <form th:action="@{/admin/returns/{id}/reject(id=${ret.orderItemId()})}" method="post"
                                      class="flex flex-col gap-1">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="orderId" th:value="${ret.orderId()}"/>
                                    <textarea name="rejectReason" rows="2" required
                                              placeholder="거절 사유를 입력하세요"
                                              class="border rounded px-2 py-1 text-xs w-full resize-none"></textarea>
                                    <div class="flex gap-1 justify-end">
                                        <button type="button"
                                                th:onclick="'toggleRejectForm(' + ${ret.orderItemId()} + ')'"
                                                class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-300">
                                            취소
                                        </button>
                                        <button type="submit"
                                                class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                            거절 확인
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <nav th:if="${returns.totalPages > 1}" class="flex justify-center mt-6">
            <div class="flex items-center gap-1">
                <a th:if="${returns.hasPrevious()}"
                   th:href="@{/admin/returns(page=${returns.number - 1})}"
                   class="px-3 py-2 text-sm border rounded hover:bg-gray-50">&laquo; 이전</a>

                <th:block th:with="start=${T(java.lang.Math).max(0, returns.number - 2)},
                                   end=${T(java.lang.Math).min(returns.totalPages - 1, returns.number + 2)}">
                    <th:block th:each="i : ${#numbers.sequence(start, end)}">
                        <a th:href="@{/admin/returns(page=${i})}"
                           th:text="${i + 1}"
                           th:classappend="${i == returns.number} ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-50'"
                           class="px-3 py-2 text-sm border rounded"></a>
                    </th:block>
                </th:block>

                <a th:if="${returns.hasNext()}"
                   th:href="@{/admin/returns(page=${returns.number + 1})}"
                   class="px-3 py-2 text-sm border rounded hover:bg-gray-50">다음 &raquo;</a>
            </div>
        </nav>
    </div>
</div>

<!-- 거절 사유 입력 영역 토글 스크립트 -->
<script th:inline="javascript">
    function toggleRejectForm(orderItemId) {
        var form = document.getElementById('reject-form-' + orderItemId);
        if (form.classList.contains('hidden')) {
            // 다른 열린 거절 폼을 모두 닫기 (한 번에 하나만 열리도록)
            document.querySelectorAll('[id^="reject-form-"]').forEach(function(el) {
                el.classList.add('hidden');
            });
            form.classList.remove('hidden');
            form.querySelector('textarea').focus();
        } else {
            form.classList.add('hidden');
        }
    }
</script>
</body>
</html>
