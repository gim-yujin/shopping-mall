<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head><title>장바구니</title></head>
<body>
<div layout:fragment="content">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">장바구니</h1>

        <div th:if="${#lists.isEmpty(cartItems)}" class="text-center py-20">
            <svg class="mx-auto h-16 w-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z"/></svg>
            <p class="text-gray-500 mb-4">장바구니가 비어있습니다.</p>
            <a th:href="@{/products}" class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">쇼핑하러 가기</a>
        </div>

        <div th:unless="${#lists.isEmpty(cartItems)}" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cart Items -->
            <div class="lg:col-span-2 space-y-4">
                <!-- [P1-6] 전체 선택/해제 체크박스 -->
                <div class="flex items-center gap-3 bg-white rounded-lg shadow px-4 py-3">
                    <input type="checkbox" id="selectAll" checked
                           onchange="toggleSelectAll(this)"
                           class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"/>
                    <label for="selectAll" class="text-sm font-medium text-gray-700">전체 선택</label>
                    <span class="text-sm text-gray-400" id="selectedCountLabel"
                          th:text="'(' + ${#lists.size(cartItems)} + '/' + ${#lists.size(cartItems)} + ')'"></span>
                </div>

                <div th:each="item : ${cartItems}" class="bg-white rounded-lg shadow p-4 flex gap-4 items-center cart-item-row">
                    <!-- [P1-6] 개별 선택 체크박스 -->
                    <input type="checkbox" class="cart-item-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 flex-shrink-0"
                           th:data-cart-id="${item.cartId}"
                           th:data-price="${item.product.price}"
                           th:data-quantity="${item.quantity}"
                           checked
                           onchange="updateSelectedSummary()"/>
                    <div class="w-24 h-24 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center">
                        <span class="text-gray-400 text-xs">이미지</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <a th:href="@{/products/{id}(id=${item.product.productId})}" class="font-medium text-gray-900 hover:text-blue-600 block truncate" th:text="${item.product.productName}">상품명</a>
                        <div class="mt-1">
                            <span th:if="${item.product.originalPrice != null and item.product.originalPrice.compareTo(item.product.price) > 0}" class="text-sm text-gray-400 line-through mr-2" th:text="${#numbers.formatDecimal(item.product.originalPrice,0,'COMMA',0,'POINT')} + '원'">0원</span>
                            <span class="text-blue-600 font-bold" th:text="${#numbers.formatDecimal(item.product.price,0,'COMMA',0,'POINT')} + '원'">0원</span>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <label class="text-sm text-gray-500">수량:</label>
                            <select class="border rounded px-2 py-1 text-sm cart-qty-select"
                                    th:data-product-id="${item.product.productId}"
                                    onchange="updateCartQty(this)">
                                <option th:each="q : ${#numbers.sequence(1, 10)}" th:value="${q}" th:text="${q}" th:selected="${q == item.quantity}">1</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="font-bold text-lg" th:text="${#numbers.formatDecimal(item.product.price * item.quantity,0,'COMMA',0,'POINT')} + '원'">0원</p>
                        <form th:action="@{/cart/remove}" method="post" class="mt-2">
                            <input type="hidden" name="productId" th:value="${item.product.productId}"/>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="text-sm text-red-500 hover:text-red-700">삭제</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 sticky top-4">
                    <h2 class="text-lg font-bold mb-4">주문 요약</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">선택 상품</span>
                            <span id="summaryItemCount" th:text="${#lists.size(cartItems)} + '개'">0개</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">상품 금액</span>
                            <span id="summaryTotalPrice" th:text="${#numbers.formatDecimal(totalPrice,0,'COMMA',0,'POINT')} + '원'">0원</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">배송비</span>
                            <span th:if="${shippingFee.compareTo(T(java.math.BigDecimal).ZERO) == 0}" class="text-green-600">무료</span>
                            <span th:unless="${shippingFee.compareTo(T(java.math.BigDecimal).ZERO) == 0}" th:text="${#numbers.formatDecimal(shippingFee,0,'COMMA',0,'POINT')} + '원'">3,000원</span>
                        </div>
                        <p th:if="${shippingFee.compareTo(T(java.math.BigDecimal).ZERO) > 0 and freeShippingThreshold != null and freeShippingThreshold.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                           class="text-xs text-gray-400 text-right"
                           th:text="${#numbers.formatDecimal(freeShippingThreshold,0,'COMMA',0,'POINT')} + '원 이상 주문 시 무료배송'"></p>
                    </div>
                    <hr class="my-4"/>
                    <div class="flex justify-between font-bold text-lg">
                        <span>총 결제금액</span>
                        <span class="text-blue-600" id="totalPrice"
                              th:text="${#numbers.formatDecimal(totalPrice.add(shippingFee),0,'COMMA',0,'POINT')} + '원'">0원</span>
                    </div>
                    <a id="checkoutBtn" th:href="@{/orders/checkout}" class="block mt-4 bg-blue-600 text-white text-center py-3 rounded-lg font-medium hover:bg-blue-700 cursor-pointer"
                       onclick="return goCheckout(event)">선택 상품 주문하기</a>
                    <a th:href="@{/products}" class="block mt-2 text-center text-sm text-gray-500 hover:text-gray-700">쇼핑 계속하기</a>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
        function updateCartQty(el) {
            const productId = el.dataset.productId;
            const quantity = el.value;
            fetch('/cart/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken},
                body: 'productId=' + productId + '&quantity=' + quantity
            }).then(r => r.json()).then(() => location.reload());
        }

        /* ── [P1-6] 장바구니 선택 주문 ── */

        /** 전체 선택/해제 토글 */
        function toggleSelectAll(masterCheckbox) {
            document.querySelectorAll('.cart-item-checkbox').forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
            updateSelectedSummary();
        }

        /** 선택 상태 변경 시 요약 정보 갱신 */
        function updateSelectedSummary() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox');
            const checked = document.querySelectorAll('.cart-item-checkbox:checked');
            const selectAll = document.getElementById('selectAll');

            // 전체 선택 체크박스 동기화
            if (selectAll) {
                selectAll.checked = checked.length === checkboxes.length;
                selectAll.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
            }

            // 선택 수량 표시
            const label = document.getElementById('selectedCountLabel');
            if (label) label.textContent = '(' + checked.length + '/' + checkboxes.length + ')';

            // 선택 상품 금액 재계산
            let selectedTotal = 0;
            checked.forEach(cb => {
                selectedTotal += parseFloat(cb.dataset.price) * parseInt(cb.dataset.quantity);
            });

            const summaryCount = document.getElementById('summaryItemCount');
            const summaryPrice = document.getElementById('summaryTotalPrice');
            const summaryTotal = document.getElementById('totalPrice');
            const checkoutBtn = document.getElementById('checkoutBtn');

            if (summaryCount) summaryCount.textContent = checked.length + '개';
            if (summaryPrice) summaryPrice.textContent = formatNum(selectedTotal) + '원';
            if (summaryTotal) summaryTotal.textContent = formatNum(selectedTotal) + '원';

            // 선택 항목이 없으면 주문 버튼 비활성화
            if (checkoutBtn) {
                if (checked.length === 0) {
                    checkoutBtn.classList.add('opacity-50', 'pointer-events-none');
                } else {
                    checkoutBtn.classList.remove('opacity-50', 'pointer-events-none');
                }
            }
        }

        function formatNum(n) {
            return Math.floor(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        /**
         * 선택한 장바구니 항목 ID를 쿼리 파라미터로 전달하여 체크아웃 페이지로 이동.
         * GET /orders/checkout?cartItemIds=1&cartItemIds=3&cartItemIds=5 형식.
         */
        function goCheckout(e) {
            e.preventDefault();
            const checked = document.querySelectorAll('.cart-item-checkbox:checked');
            if (checked.length === 0) {
                alert('주문할 상품을 선택해주세요.');
                return false;
            }
            const params = new URLSearchParams();
            checked.forEach(cb => params.append('cartItemIds', cb.dataset.cartId));
            window.location.href = '/orders/checkout?' + params.toString();
            return false;
        }
    </script>
</div>
</body>
</html>
