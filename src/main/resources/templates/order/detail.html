<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head><title>주문 상세</title></head>
<body>
<div layout:fragment="content">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">주문 상세</h1>
            <a th:href="@{/orders}" class="text-sm text-gray-500 hover:text-gray-700">← 주문 목록</a>
        </div>

        <!-- Order Status -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">주문번호: <span th:text="${order.orderNumber}">ORD-001</span></p>
                    <p class="text-sm text-gray-500">주문일: <span th:text="${#temporals.format(order.orderDate, 'yyyy.MM.dd HH:mm')}">2024.01.01</span></p>
                </div>
                <span class="px-4 py-2 text-sm font-medium rounded-full"
                      th:classappend="${order.orderStatus.badgeClass}"
                      th:text="${order.orderStatus.label}">상태</span>
            </div>

            <!-- Progress Bar -->
            <div th:if="${order.orderStatusCode != 'CANCELLED'}" class="mt-6">
                <div class="flex items-center justify-between relative">
                    <div th:each="step, stat : ${ {'결제대기','결제완료','배송중','배송완료'} }" class="flex flex-col items-center z-10">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold"
                             th:classappend="${(stat.index <= order.orderStatus.progressIndex)
                                              ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}"
                             th:text="${stat.index + 1}">1</div>
                        <span class="text-xs mt-1 text-gray-500" th:text="${step}">단계</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Shipping Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-3">배송 정보</h2>
                <div class="space-y-2 text-sm">
                    <p><span class="text-gray-500 w-20 inline-block">수령인</span> <span th:text="${order.recipientName}">이름</span></p>
                    <p><span class="text-gray-500 w-20 inline-block">연락처</span> <span th:text="${order.recipientPhone}">010-0000-0000</span></p>
                    <p><span class="text-gray-500 w-20 inline-block">주소</span> <span th:text="${order.shippingAddress}">주소</span></p>
                    <!-- [3.6] 택배사·송장번호 표시 (SHIPPED 이후 상태에서만) -->
                    <div th:if="${order.carrier != null or order.trackingNumber != null}" class="mt-3 pt-3 border-t">
                        <p th:if="${order.carrier != null}"><span class="text-gray-500 w-20 inline-block">택배사</span> <span th:text="${order.carrier}" class="font-medium">택배사</span></p>
                        <p th:if="${order.trackingNumber != null}"><span class="text-gray-500 w-20 inline-block">송장번호</span> <span th:text="${order.trackingNumber}" class="font-mono bg-gray-100 px-2 py-0.5 rounded">송장번호</span></p>
                        <p th:if="${order.shippedAt != null}"><span class="text-gray-500 w-20 inline-block">발송일</span> <span th:text="${#temporals.format(order.shippedAt, 'yyyy.MM.dd HH:mm')}">날짜</span></p>
                    </div>
                </div>
            </div>

            <!-- Payment Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-3">결제 정보</h2>
                <div class="space-y-2 text-sm">
                    <p><span class="text-gray-500 w-20 inline-block">결제수단</span>
                        <span th:text="${order.paymentMethod == 'CARD' ? '신용/체크카드' :
                                        order.paymentMethod == 'BANK' ? '계좌이체' :
                                        order.paymentMethod == 'KAKAO' ? '카카오페이' :
                                        order.paymentMethod == 'NAVER' ? '네이버페이' :
                                        order.paymentMethod == 'PAYCO' ? '페이코' : order.paymentMethod}">카드</span>
                    </p>
                    <div class="flex justify-between"><span class="text-gray-500">상품금액</span><span th:text="${#numbers.formatDecimal(order.totalAmount,0,'COMMA',0,'POINT')} + '원'">0원</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">할인금액</span><span class="text-red-500" th:text="'-' + ${#numbers.formatDecimal(order.discountAmount,0,'COMMA',0,'POINT')} + '원'">0원</span></div>
                    <div th:if="${order.usedPoints > 0}" class="flex justify-between"><span class="text-gray-500">포인트 사용</span><span class="text-red-500" th:text="'-' + ${#numbers.formatDecimal(order.usedPoints,0,'COMMA',0,'POINT')} + '원 (' + ${#numbers.formatDecimal(order.usedPoints,0,'COMMA',0,'POINT')} + 'P)'">0원</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">배송비</span><span th:text="${#numbers.formatDecimal(order.shippingFee,0,'COMMA',0,'POINT')} + '원'">0원</span></div>
                    <hr/>
                    <div class="flex justify-between font-bold"><span>총 결제금액</span><span class="text-blue-600" th:text="${#numbers.formatDecimal(order.finalAmount,0,'COMMA',0,'POINT')} + '원'">0원</span></div>
                    <div th:if="${order.refundedAmount > 0}" class="flex justify-between text-sm"><span class="text-gray-500">누적 환불금액</span><span class="text-red-500" th:text="${#numbers.formatDecimal(order.refundedAmount,0,'COMMA',0,'POINT')} + '원'">0원</span></div>
                    <div th:if="${order.earnedPointsSnapshot > 0}" class="flex justify-between text-xs mt-1"
                         th:classappend="${order.pointsSettled ? 'text-green-500' : 'text-gray-400'}">
                        <span th:text="${order.pointsSettled ? '적립 완료' : '적립 예정'}">적립 상태</span>
                        <span th:text="'+' + ${#numbers.formatDecimal(order.earnedPointsSnapshot,0,'COMMA',0,'POINT')} + 'P'">0P</span>
                    </div>
                    <p th:if="${order.earnedPointsSnapshot > 0}"
                       class="text-[11px] text-gray-400 mt-1"
                       title="적립 포인트는 배송완료 처리 시점에 정산됩니다.">
                        ※ 적립 포인트는 배송완료 시 정산됩니다.
                    </p>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <!--
            [Step 4] 아이템별 상태 배지, 반품 사유 선택, 진행 상태 메시지 추가.

            문제: 기존 UI는 OrderItemStatus를 표시하지 않아 반품 신청 후
            사용자가 현재 처리 상태(대기/거절/완료)를 확인할 수 없었다.
            또한 반품 사유를 입력받지 않아 관리자의 승인/거절 판단 근거가 부족했다.

            해결:
            1. 상태 배지: NORMAL이 아닌 경우 Tailwind 배지로 현재 상태를 표시한다.
            2. 반품 사유 선택: <select>로 사유를 필수 입력받아 관리자에게 전달한다.
            3. 진행 상태 메시지: RETURN_REQUESTED(대기 안내), RETURN_REJECTED(거절 사유 표시)를
               아이템별로 인라인 메시지로 표시한다.
            4. 폼 조건 강화: 반품 신청 폼은 DELIVERED 상태 + NORMAL 아이템에서만 표시하고,
               거절(RETURN_REJECTED)된 아이템은 재신청 폼을 별도 표시한다.
        -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">주문 상품</h2>
            <div class="divide-y">
                <div th:each="item : ${order.items}" class="py-4 border-b last:border-b-0">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gray-100 rounded flex-shrink-0 flex items-center justify-center">
                            <span class="text-gray-400 text-xs">IMG</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <p class="font-medium" th:text="${item.productName}">상품명</p>
                                <!-- [Step 4] 아이템 상태 배지: NORMAL이 아닌 경우만 표시.
                                     OrderItemStatus.badgeClass를 Tailwind 클래스로 적용하여
                                     상태별 색상을 일관되게 표현한다. -->
                                <span th:if="${item.status.name() != 'NORMAL'}"
                                      class="px-2 py-0.5 text-xs rounded-full"
                                      th:classappend="${item.status.badgeClass}"
                                      th:text="${item.status.label}">상태</span>
                            </div>
                            <p class="text-sm text-gray-500"><span th:text="${#numbers.formatDecimal(item.unitPrice,0,'COMMA',0,'POINT')}">0</span>원 × <span th:text="${item.quantity}">1</span></p>
                            <p class="text-xs text-gray-400" th:if="${item.cancelledQuantity > 0 or item.returnedQuantity > 0}">
                                취소 <span th:text="${item.cancelledQuantity}">0</span>개 / 반품 <span th:text="${item.returnedQuantity}">0</span>개
                            </p>
                            <!-- [Step 4] 반품 대기 수량 표시: 반품 진행 중인 수량을 별도 표시하여
                                 사용자가 어떤 수량이 처리 대기 중인지 명확히 알 수 있도록 한다. -->
                            <p class="text-xs text-orange-500" th:if="${item.pendingReturnQuantity > 0}">
                                반품 대기 <span th:text="${item.pendingReturnQuantity}">0</span>개
                            </p>
                        </div>
                        <span class="font-bold" th:text="${#numbers.formatDecimal(item.subtotal,0,'COMMA',0,'POINT')} + '원'">0원</span>
                    </div>

                    <!-- [Step 4] 반품 진행 상태 메시지.
                         관리자 승인 전까지의 처리 상태를 사용자에게 안내하여
                         불필요한 문의를 줄이고 투명한 운영을 보장한다. -->
                    <p th:if="${item.status.name() == 'RETURN_REQUESTED'}" class="text-xs text-orange-600 mt-2">
                        반품 신청이 접수되었습니다. 관리자 승인을 기다리고 있습니다.
                    </p>
                    <!-- 거절 시 거절 사유를 표시하여 사용자가 재신청 여부를 판단할 수 있도록 한다. -->
                    <p th:if="${item.status.name() == 'RETURN_REJECTED'}" class="text-xs text-red-600 mt-2">
                        반품이 거절되었습니다: <span th:text="${item.rejectReason}" class="font-medium">사유</span>
                    </p>
                    <p th:if="${item.status.name() == 'RETURNED'}" class="text-xs text-gray-500 mt-2">
                        반품 처리가 완료되었습니다.
                        <span th:if="${item.returnedAt != null}">
                            (<span th:text="${#temporals.format(item.returnedAt, 'yyyy.MM.dd HH:mm')}">날짜</span>)
                        </span>
                    </p>

                    <div class="mt-3 flex flex-wrap gap-2">
                        <!-- 부분 취소 폼: PENDING/PAID + 잔여 수량 > 0 + NORMAL 상태에서만 표시.
                             Step 4에서 NORMAL 상태 조건을 추가하여 반품 진행 중인 아이템에
                             부분 취소가 중복 노출되지 않도록 한다. -->
                        <form th:if="${item.remainingQuantity > 0
                                       and (order.orderStatusCode == 'PENDING' or order.orderStatusCode == 'PAID')
                                       and item.status.name() == 'NORMAL'}"
                              th:action="@{/orders/{id}/partial-cancel(id=${order.orderId})}" method="post"
                              class="flex items-center gap-2"
                              onsubmit="return confirm('해당 상품을 부분 취소하시겠습니까?')">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="orderItemId" th:value="${item.orderItemId}"/>
                            <input type="number" name="quantity" min="1" th:max="${item.remainingQuantity}" value="1" class="w-20 border rounded px-2 py-1 text-sm"/>
                            <button type="submit" class="text-xs bg-red-500 text-white px-3 py-1 rounded">부분 취소</button>
                        </form>

                        <!-- [Step 4] 반품 신청 폼: DELIVERED + NORMAL 상태 + 잔여 수량 > 0에서만 표시.
                             기존에는 item.status 조건 없이 DELIVERED 상태만 확인했으나,
                             반품 진행 중(RETURN_REQUESTED/RETURN_APPROVED) 아이템에도
                             폼이 노출되는 문제가 있었다. NORMAL 상태 검증을 추가한다.

                             반품 사유(returnReason) <select>를 필수 입력으로 추가하여
                             관리자가 승인/거절 판단에 활용할 수 있도록 한다. -->
                        <form th:if="${item.remainingQuantity > 0
                                       and order.orderStatusCode == 'DELIVERED'
                                       and item.status.name() == 'NORMAL'}"
                              th:action="@{/orders/{id}/return(id=${order.orderId})}" method="post"
                              class="flex items-center gap-2"
                              onsubmit="return confirm('해당 상품을 반품 신청하시겠습니까?')">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="orderItemId" th:value="${item.orderItemId}"/>
                            <select name="returnReason" required class="border rounded px-2 py-1 text-xs">
                                <option value="">반품 사유 선택</option>
                                <option value="DEFECT">상품 불량/파손</option>
                                <option value="WRONG_ITEM">오배송</option>
                                <option value="CHANGE_OF_MIND">단순 변심</option>
                                <option value="SIZE_ISSUE">사이즈 불일치</option>
                                <option value="OTHER">기타</option>
                            </select>
                            <input type="number" name="quantity" min="1" th:max="${item.remainingQuantity}" value="1" class="w-20 border rounded px-2 py-1 text-sm"/>
                            <button type="submit" class="text-xs bg-gray-700 text-white px-3 py-1 rounded">반품 신청</button>
                        </form>

                        <!-- [Step 4] 거절 후 재신청 폼: RETURN_REJECTED 상태 + 잔여 수량 > 0에서 표시.
                             상태 전이 규칙에서 RETURN_REJECTED → RETURN_REQUESTED 재신청을
                             허용하므로, 사용자가 추가 증빙이나 다른 사유로 재시도할 수 있도록 한다.
                             실제 반품 기간 검증은 서버에서 수행한다. -->
                        <form th:if="${item.remainingQuantity > 0
                                       and order.orderStatusCode == 'DELIVERED'
                                       and item.status.name() == 'RETURN_REJECTED'}"
                              th:action="@{/orders/{id}/return(id=${order.orderId})}" method="post"
                              class="flex items-center gap-2"
                              onsubmit="return confirm('반품을 재신청하시겠습니까?')">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="orderItemId" th:value="${item.orderItemId}"/>
                            <select name="returnReason" required class="border rounded px-2 py-1 text-xs">
                                <option value="">반품 사유 선택</option>
                                <option value="DEFECT">상품 불량/파손</option>
                                <option value="WRONG_ITEM">오배송</option>
                                <option value="CHANGE_OF_MIND">단순 변심</option>
                                <option value="SIZE_ISSUE">사이즈 불일치</option>
                                <option value="OTHER">기타</option>
                            </select>
                            <input type="number" name="quantity" min="1" th:max="${item.remainingQuantity}" value="1" class="w-20 border rounded px-2 py-1 text-sm"/>
                            <button type="submit" class="text-xs bg-orange-500 text-white px-3 py-1 rounded">재신청</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancel Button -->
        <div th:if="${order.orderStatusCode == 'PENDING' or order.orderStatusCode == 'PAID'}" class="text-center">
            <form th:action="@{/orders/{id}/cancel(id=${order.orderId})}" method="post" onsubmit="return confirm('정말 주문을 취소하시겠습니까?')">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="bg-red-500 text-white px-8 py-3 rounded-lg hover:bg-red-600">주문 취소</button>
            </form>
        </div>
    </div>
</div>
</body>
</html>
